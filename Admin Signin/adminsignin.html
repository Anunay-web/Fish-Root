<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äî ExpenseFlow</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Interactivity and Aesthetics */
        body {
            font-family: 'Inter', sans-serif;
        }
        .section {
            transition: opacity 0.5s ease;
        }
        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .active-menu {
            background-color: #3b82f6 !important; /* Blue 500 */
            color: white !important;
            font-weight: 600;
        }
        .active-menu:hover {
            background-color: #1e40af !important; /* Blue 800 */
        }
        /* Style for Toast Container */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .status-badge { 
            padding: 0.2rem 0.5rem; 
            border-radius: 0.375rem; 
            font-size: 0.75rem; 
            font-weight: 600; 
            color: white; 
        }
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s;
        }
        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-out;
        }
        .modal-container.open .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <!-- Expense Detail Modal Container -->
    <div id="modal-container" class="modal-container hidden fixed inset-0 z-40 flex items-center justify-center modal-bg" onclick="if(event.target.id === 'modal-container') closeModal()">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 modal-content">
            <!-- Modal Content goes here -->
        </div>
    </div>
    
    <!-- Navbar -->
    <header class=" p-4 flex justify-between items-center">
        <h1 class="text-3xl text-black font-semibold  tracking-wide">Fish Root <span class="text-indigo-400 text-xl font-normal">Admin</span></h1>
        <button id="logoutBtn" class="bg-indigo-800 px-4 py-2 rounded-lg hover:bg-indigo-900 transition transform hover:scale-105 shadow-md">
            Logout
        </button>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-xl p-6 h-screen sticky top-0">
            <h2 class="font-bold text-xl text-gray-800 mb-6 border-b pb-2">Control Panel</h2>
            <ul class="space-y-3">
                <li><button class="menuBtn w-full text-left px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition" data-section="dashboard">üìä Dashboard</button></li>
                <li><button class="menuBtn w-full text-left px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition" data-section="approvals">‚úÖ Expense Table</button></li>
                <li><button class="menuBtn w-full text-left px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 transition" data-section="excel">‚¨áÔ∏è Export Data</button></li>
            </ul>
    
            <div class="mt-8 pt-4 border-t border-gray-200">
                <label class="text-gray-600 font-semibold mb-2 block text-sm">Filter Pending Claims:</label>
                <select id="managerFilter" class="w-full border rounded-lg p-2 text-sm">
                    <option value="all">All Managers</option>
                </select>
                <button id="applyManagerFilter" class="mt-2 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition transform hover:scale-[1.02]">Apply Filter</button>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1 p-8">
            
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Financial Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Card 1: Total Expenses -->
                    <div class="bg-white card shadow-lg rounded-xl p-6 border-l-4 border-indigo-500">
                        <h3 class="font-semibold text-gray-500 text-sm uppercase">Total Expenses Processed</h3>
                        <p id="totalExpenses" class="text-4xl font-extrabold text-indigo-700 mt-2">$0</p>
                    </div>
                    <!-- Card 2: Pending Approvals -->
                    <div class="bg-white card shadow-lg rounded-xl p-6 border-l-4 border-yellow-500">
                        <h3 class="font-semibold text-gray-500 text-sm uppercase">Pending Approvals</h3>
                        <p id="pendingCount" class="text-4xl font-extrabold text-yellow-700 mt-2">0</p>
                    </div>
                    <!-- Card 3: Manager Approved -->
                    <div class="bg-white card shadow-lg rounded-xl p-6 border-l-4 border-green-500">
                        <h3 class="font-semibold text-gray-500 text-sm uppercase">Manager Approved (Next Step)</h3>
                        <p id="managerApprovedCount" class="text-4xl font-extrabold text-green-700 mt-2">0</p>
                    </div>
                </div>
            </section>

            <!-- Pending Approvals -->
            <section id="approvals" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Expense Claims Table</h2>
                
                <!-- Filter Controls -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="expenseSearch" placeholder="Search employee or expense type..." 
                           class="flex-1 min-w-[200px] border border-gray-300 rounded-lg p-2.5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"/>
                    
                    <select id="statusToggle" class="border border-gray-300 rounded-lg p-2.5 shadow-sm text-sm bg-white focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="Pending">Pending Approvals</option>
                        <option value="Approved">Approved Claims</option>
                        <option value="Rejected">Rejected Claims</option>
                        <option value="All">All Claims</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white shadow-xl rounded-xl">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr class="text-left text-gray-600 uppercase text-xs tracking-wider">
                                <th class="px-6 py-3 font-semibold">Employee</th>
                                <th class="px-6 py-3 font-semibold">Expense</th>
                                <th class="px-6 py-3 font-semibold">Amount</th>
                                <th class="px-6 py-3 font-semibold">Submitted</th>
                                <th class="px-6 py-3 font-semibold">Manager</th>
                                <th class="px-6 py-3 font-semibold">Status</th>
                                <th class="px-6 py-3 font-semibold text-center action-col">Admin Action</th>
                            </tr>
                        </thead>
                        <tbody id="approvalTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                    <p id="noApprovals" class="text-center py-12 text-gray-500 hidden bg-white rounded-b-xl shadow-lg">No claims match the current filters. üéâ</p>
                </div>
            </section>

            <!-- Export Excel -->
            <section id="excel" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Export Expenses Data</h2>
                <p class="text-gray-600 mb-6">Download a complete list of all expense claims for financial auditing and reporting.</p>
                <button id="exportBtn" class="bg-green-600 px-6 py-3 rounded-lg text-white font-semibold hover:bg-green-700 transition transform hover:scale-[1.02] shadow-md">
                    ‚¨áÔ∏è Download All Data (.xlsx)
                </button>
            </section>
        </main>
    </div>

    <!-- External Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // --- Custom Toast Notification Function ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let color = '';
            switch (type) {
                case 'success': color = 'bg-green-500'; break;
                case 'error': color = 'bg-red-500'; break;
                default: color = 'bg-gray-700';
            }

            toast.className = `toast p-4 rounded-lg shadow-xl text-white mb-3 ${color}`;
            toast.textContent = message;
            container.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Modal Control Functions ---
        function closeModal() {
            const modal = document.getElementById('modal-container');
            modal.classList.remove('open');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function showExpenseDetailModal(exp) {
            const modal = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            
            const adminStatus = exp.adminApproved === true ? 'Approved' : (exp.adminApproved === false ? 'Rejected' : 'Pending');
            const managerStatus = exp.managerApproved ? 'Approved' : 'Pending';

            content.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Expense Details</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-900 transition text-2xl font-semibold">&times;</button>
                </div>
                <div class="space-y-3">
                    <p class="text-lg font-extrabold text-indigo-600">$${exp.amount.toFixed(2)} (${exp.expense})</p>
                    <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-700">
                        <p><span class="font-semibold">Employee:</span> ${exp.employee}</p>
                        <p><span class="font-semibold">Manager:</span> ${exp.manager}</p>
                        <p><span class="font-semibold">Submission Date:</span> ${exp.submissionDate}</p>
                        <p><span class="font-semibold">Status:</span> ${exp.status}</p>
                    </div>
                    <div class="p-3 border rounded-lg bg-gray-50 mt-4">
                        <p class="font-semibold text-gray-800 mb-1">Detailed Justification:</p>
                        <p class="text-sm text-gray-600 italic">${exp.justification || "No detailed justification provided."}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 text-sm">
                        <p class="font-bold mb-1">Approval Trail:</p>
                        <p>Manager Review: <span class="text-${managerStatus === 'Approved' ? 'green' : 'red'}-600 font-semibold">${managerStatus}</span></p>
                        <p>Admin Final: <span class="text-${adminStatus === 'Approved' ? 'green' : (adminStatus === 'Rejected' ? 'red' : 'yellow')}-600 font-semibold">${adminStatus}</span></p>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            // Timeout ensures CSS transition runs after display block
            setTimeout(() => modal.classList.add('open'), 10);
        }


        // --- Counter Animation Function ---
        function animateCounter(id, finalValue, duration = 1000) {
            const element = document.getElementById(id);
            if (!element) return;
            const startValue = 0;
            let startTime = null;

            const step = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                const percentage = Math.min(progress / duration, 1);
                // For currency, floor the value, for counts, keep it integer
                const currentValue = id === 'totalExpenses' ? (percentage * finalValue) : Math.floor(percentage * finalValue);

                // Format amount with currency symbol and 2 decimal places
                let displayText = (id === 'totalExpenses') ? `$${currentValue.toFixed(2)}` : Math.floor(currentValue);
                
                element.innerText = displayText;

                if (percentage < 1) {
                    window.requestAnimationFrame(step);
                }
            };

            window.requestAnimationFrame(step);
        }

        // Mock expense data (Updated to include date and justification)
        let expenses = [
            { id: 0, employee: "Alice", expense: "Travel Reimbursement", amount: 120.50, manager: "John Doe", managerApproved: true, adminApproved: null, status: 'Pending', submissionDate: '2024-10-01', justification: "Required travel for Q4 client presentation in NYC." },
            { id: 1, employee: "Bob", expense: "Office Supplies", amount: 50.00, manager: "Mary Jane", managerApproved: false, adminApproved: null, status: 'Pending', submissionDate: '2024-10-02', justification: "Purchase of ergonomic mouse and keyboard for workstation setup." },
            { id: 2, employee: "Charlie", expense: "Client Lunch", amount: 30.75, manager: "John Doe", managerApproved: true, adminApproved: null, status: 'Pending', submissionDate: '2024-10-03', justification: "Meal with client Sarah Connor to discuss contract renewal." },
            { id: 3, employee: "David", expense: "Software Subscription", amount: 99.99, manager: "Mary Jane", managerApproved: true, adminApproved: true, status: 'Approved', submissionDate: '2024-09-28', justification: "Annual license renewal for specialized project management software." },
            { id: 4, employee: "Eve", expense: "Conference Fee", amount: 500.00, manager: "John Doe", managerApproved: false, adminApproved: null, status: 'Pending', submissionDate: '2024-10-04', justification: "Registration fee for the annual industry technology summit." },
            // NEW ENTRY for Anunay
            { id: 5, employee: "Anunay", expense: "Server Upgrade", amount: 1500.00, manager: "Jane Smith", managerApproved: true, adminApproved: null, status: 'Pending', submissionDate: '2024-10-05', justification: "Urgent purchase for production server RAM and SSD upgrade." },
        ];

        // --- Manager Filter Setup ---
        const managerSelect = document.getElementById('managerFilter');
        [...new Set(expenses.map(e => e.manager))].forEach(mgr => {
            const opt = document.createElement('option');
            opt.value = mgr; opt.textContent = mgr;
            managerSelect.appendChild(opt);
        });

        // --- Sidebar navigation ---
        const menuButtons = document.querySelectorAll('.menuBtn');
        const sections = document.querySelectorAll('.section');

        function setActiveMenu(activeSectionId) {
            menuButtons.forEach(btn => {
                btn.classList.remove('active-menu', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700');
                if (btn.dataset.section === activeSectionId) {
                    btn.classList.add('active-menu', 'bg-blue-600', 'text-white');
                }
            });
            sections.forEach(sec => sec.classList.add('hidden'));
            document.getElementById(activeSectionId).classList.remove('hidden');
            
            // Re-render when switching to the expense table
            if (activeSectionId === 'approvals') {
                // Get current filters from the DOM elements
                const currentSearch = document.getElementById('expenseSearch')?.value || '';
                const currentManager = managerSelect.value;
                const currentStatus = document.getElementById('statusToggle')?.value || 'Pending';
                renderExpenseTable(currentManager, currentSearch, currentStatus);
            }
        }

        menuButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveMenu(btn.dataset.section);
                if (btn.dataset.section === 'dashboard') {
                    renderDashboard(true);
                }
            });
        });

        // --- Populate expense table (formerly renderApprovals) ---
        function renderExpenseTable(managerFilter = 'all', searchTerm = '', statusFilter = 'Pending') {
            const tbody = document.getElementById('approvalTable');
            const searchLower = searchTerm.toLowerCase();
            
            let filteredExpenses = expenses.filter(e => {
                // 1. Status Filter
                if (statusFilter !== 'All' && e.status !== statusFilter) return false;
                
                // 2. Manager Filter (only relevant if status is Pending, but applied globally here for flexibility)
                if (managerFilter !== 'all' && e.manager !== managerFilter) return false;
                
                // 3. Search Term Filter
                if (searchTerm && !(e.employee.toLowerCase().includes(searchLower) || e.expense.toLowerCase().includes(searchLower))) {
                    return false;
                }
                
                return true;
            });
            
            // Sort by submission date (newest first)
            filteredExpenses.sort((a, b) => new Date(b.submissionDate) - new Date(a.submissionDate));

            tbody.innerHTML = '';

            if (filteredExpenses.length === 0) {
                document.getElementById('noApprovals').classList.remove('hidden');
                return;
            } else {
                document.getElementById('noApprovals').classList.add('hidden');
            }
            
            // Determine if action buttons should be visible (only for pending items)
            const showActions = statusFilter === 'Pending';
            document.querySelector('.action-col').style.display = showActions ? 'table-cell' : 'none';
            

            filteredExpenses.forEach(exp => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 transition duration-150 cursor-pointer';
                tr.setAttribute('data-id', exp.id); // For row click event
                
                const managerStatus = exp.managerApproved 
                    ? '<span class="status-badge bg-green-500">Approved ‚úÖ</span>' 
                    : '<span class="status-badge bg-red-500">Pending ‚ùå</span>';
                
                let adminStatusBadge;
                switch(exp.status) {
                    case 'Pending': adminStatusBadge = '<span class="status-badge bg-yellow-500">Pending</span>'; break;
                    case 'Approved': adminStatusBadge = '<span class="status-badge bg-green-500">Approved</span>'; break;
                    case 'Rejected': adminStatusBadge = '<span class="status-badge bg-red-500">Rejected</span>'; break;
                    default: adminStatusBadge = '<span class="status-badge bg-gray-500">Unknown</span>';
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${exp.employee}</td>
                    <td class="px-6 py-4 text-gray-600">${exp.expense}</td>
                    <td class="px-6 py-4 font-semibold text-indigo-700">$${exp.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 text-gray-500">${exp.submissionDate}</td>
                    <td class="px-6 py-4 font-medium text-gray-800">${exp.manager}</td>
                    <td class="px-6 py-4">${adminStatusBadge}</td>
                    <td class="px-6 py-4 text-center space-x-2 action-col-data">
                        ${showActions && exp.managerApproved !== false ? `
                            <button data-id="${exp.id}" class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-700 transition approveBtn transform hover:scale-105">Approve</button>
                            <button data-id="${exp.id}" class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-700 transition rejectBtn transform hover:scale-105">Reject</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Re-attach listeners for actions and row clicks
            document.querySelectorAll('.approveBtn').forEach(btn => btn.addEventListener('click', e => {
                // Stop propagation so the row click/modal doesn't fire
                e.stopPropagation(); 
                handleApproval(e.target.dataset.id, true);
            }));
            document.querySelectorAll('.rejectBtn').forEach(btn => btn.addEventListener('click', e => {
                e.stopPropagation();
                handleApproval(e.target.dataset.id, false);
            }));
            
            document.querySelectorAll('#approvalTable tr').forEach(row => {
                row.addEventListener('click', e => {
                    const id = e.currentTarget.dataset.id;
                    const exp = expenses.find(item => item.id == id);
                    if (exp) showExpenseDetailModal(exp);
                });
            });
        }
        
        // --- Approval Action Handler ---
        function handleApproval(id, isApproved) {
            const expIndex = expenses.findIndex(e => e.id == id);
            if (expIndex === -1) {
                return showToast('Error: Expense not found.', 'error');
            }
            
            expenses[expIndex].adminApproved = isApproved;
            expenses[expIndex].status = isApproved ? 'Approved' : 'Rejected';
            
            const actionText = isApproved ? 'approved' : 'rejected';
            showToast(`Admin successfully ${actionText} ${expenses[expIndex].employee}'s ${expenses[expIndex].expense} claim.`, isApproved ? 'success' : 'error');

            // Re-render table using current filters
            const currentSearch = document.getElementById('expenseSearch').value;
            const currentManager = managerSelect.value;
            const currentStatus = document.getElementById('statusToggle').value;
            renderExpenseTable(currentManager, currentSearch, currentStatus);
            renderDashboard(false);
        }


        // --- Render dashboard stats ---
        function renderDashboard(doAnimate = false) {
            const total = expenses.reduce((a,b) => a + (b.amount || 0), 0);
            const pending = expenses.filter(e => e.status === 'Pending').length;
            const managerApproved = expenses.filter(e => e.managerApproved && e.adminApproved === null && e.status === 'Pending').length;

            // Update with fixed values if not animating, or run animation
            if (doAnimate) {
                document.getElementById('totalExpenses').innerText = '$0';
                document.getElementById('pendingCount').innerText = '0';
                document.getElementById('managerApprovedCount').innerText = '0';

                animateCounter('totalExpenses', total, 1500);
                animateCounter('pendingCount', pending, 1500);
                animateCounter('managerApprovedCount', managerApproved, 1500);
            } else {
                document.getElementById('totalExpenses').innerText = `$${total.toFixed(2)}`;
                document.getElementById('pendingCount').innerText = pending;
                document.getElementById('managerApprovedCount').innerText = managerApproved;
            }
        }

        // --- Export Excel ---
        document.getElementById('exportBtn').addEventListener('click', () => {
            const dataToExport = expenses.map(exp => ({
                Employee: exp.employee,
                Expense: exp.expense,
                Amount: `$${exp.amount.toFixed(2)}`,
                Manager: exp.manager,
                Manager_Approved: exp.managerApproved ? 'Yes' : 'No',
                Admin_Status: exp.adminApproved === true ? 'Approved' : (exp.adminApproved === false ? 'Rejected' : 'Pending'),
                Date: exp.submissionDate,
                Justification: exp.justification
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'AllExpenses');
            XLSX.writeFile(wb, 'ExpenseFlow_Report.xlsx');
            showToast('Data successfully downloaded!', 'success');
        });

        // --- Event Listeners for Filters ---
        document.getElementById('applyManagerFilter').addEventListener('click', () => {
            const currentSearch = document.getElementById('expenseSearch').value;
            const currentStatus = document.getElementById('statusToggle').value;
            renderExpenseTable(managerSelect.value, currentSearch, currentStatus);
        });

        document.getElementById('expenseSearch').addEventListener('input', () => {
            const currentManager = managerSelect.value;
            const currentStatus = document.getElementById('statusToggle').value;
            renderExpenseTable(currentManager, document.getElementById('expenseSearch').value, currentStatus);
        });
        
        document.getElementById('statusToggle').addEventListener('change', (e) => {
            const currentSearch = document.getElementById('expenseSearch').value;
            const currentManager = managerSelect.value;
            renderExpenseTable(currentManager, currentSearch, e.target.value);
        });

        // --- Logout button ---
        document.getElementById('logoutBtn').addEventListener('click', () => {
            showToast('Logging out...', 'info');
            // Mock redirect
            setTimeout(() => {
                window.location.reload(); 
            }, 1000); 
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial render uses default filters
            renderExpenseTable(managerSelect.value, '', document.getElementById('statusToggle').value); 
            renderDashboard(true); 
            setActiveMenu('dashboard');
        });
    </script>

</body>
</html>
